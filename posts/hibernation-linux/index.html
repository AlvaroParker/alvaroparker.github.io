<!doctype html><html lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><title> How to configure hibernation with a swap file and encrypted root partition </title><link href=/menu_icon/favicon.svg rel=icon type=image/png><link href="https://await.cl/ atom.xml" title="Alvaro's Blog" rel=alternate type=application/atom+xml><link href=https://await.cl/main.css media=screen rel=stylesheet><script>MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']]
      }
    };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js></script><meta content="A personal portfolio/blog website of Alvaro Parker del Fierro" name=description><meta content="A personal portfolio/blog website of Alvaro Parker del Fierro" name=description><meta content="index, nofollow" name=robots><meta content="Alvaro's Blog" property=og:title><meta content=article property=og:type><meta content=/menu_icon/profile_pic.jpg property=og:image><meta content=/menu_icon/profile_pic.jpg name=twitter:card><meta content=https://await.cl/posts/hibernation-linux/ property=og:url><meta content="A personal portfolio/blog website of Alvaro Parker del Fierro" property=og:description><meta content="Alvaro's Blog" property=og:site_name><body><header><div class=navbar><div class="nav-title nav-navs"><a class="nav-links home-title" href=https://await.cl>Alvaro's Blog</a></div><nav class="nav-title nav-navs"><a class=nav-links href=/projects> <img alt=Projects height=15 src=/menu_icon/projects.png width=15> Projects</a><a class=nav-links href=/about> <img alt=About height=15 src=/menu_icon/profile_pic.jpg width=15> About</a></nav><nav class="socials nav-navs"><label class=theme-switcher for=themeswitch><div class=background></div> <input id=themeswitch type=checkbox> <div class=switch><img alt="theme switch to dark" class=moon src=/menu_icon/moon.png><img alt="theme switch to light" class=sun src=/menu_icon/sun.png></div></label></nav></div></header><div class=content><main><article><div class=title><h2>How to configure hibernation with a swap file and encrypted root partition</h2><div class=meta>Posted on <time>2025-01-06</time><div class=post-tags><nav class="nav tags">üè∑: <a href=https://await.cl/tags/linux/>Linux</a> ¬† <a href=https://await.cl/tags/swap/>Swap</a> ¬† <a href=https://await.cl/tags/arch-linux/>Arch Linux</a> ¬†</nav></div> ||<span> 5 minute read</span></div></div><h1>Table of Contents</h1><ul><li><a href=https://await.cl/posts/hibernation-linux/#how-to-enable-hibernation>How to enable hibernation</a> <ul><li><a href=https://await.cl/posts/hibernation-linux/#creating-a-swapfile>Creating a swapfile</a><li><a href=https://await.cl/posts/hibernation-linux/#enabling-hibernation>Enabling hibernation</a></li><ul><li><a href=https://await.cl/posts/hibernation-linux/#get-resume-parameter>Get resume parameter</a><li><a href=https://await.cl/posts/hibernation-linux/#get-resume-offset-parameter>Get resume_offset parameter</a><li><a href=https://await.cl/posts/hibernation-linux/#adding-the-parameter-to-the-kernel-cmd-line>Adding the parameter to the kernel cmd line</a><li><a href=https://await.cl/posts/hibernation-linux/#rebuilding-your-unified-kernel-image>Rebuilding your unified kernel image</a></ul><li><a href=https://await.cl/posts/hibernation-linux/#some-tips>Some tips</a></ul></ul><section class=body><h1 id=how-to-enable-hibernation>How to enable hibernation</h1><p>This post assumes you followed the installation guide on <a href=https://github.com/AlvaroParker/secure-arch/tree/main>Secure-Arch</a> (credits to <a href=https://github.com/Ataraxxia>Ataraxxia</a>). This means you have Arch installed with a Unified Kernel Image, encrypted with LVM and secure boot enabled.<h2 id=creating-a-swapfile>Creating a swapfile</h2><p>The first things you'll need to enable hibernation on this specific configuration is to create a swap file. I don't like using swap partitions simply because that would imply I'll have to encrypt that partition as well and I don't want to read the docs to do that.<p>So, following the Arch Linux wiki on <a href=https://wiki.archlinux.org/title/Swap#Swap_file>swap files</a>, we can create a new one by doing:<pre class=z-code><code><span class="z-text z-plain"># mkswap -U clear --size 12G --file /swapfile
</span></code></pre><p>I'll choose <code>12G</code> becuase my current laptop has roughly <code>6G</code>. The general rule to choose swap size is:<ul><li>2 GB or less of RAM: Swap should be at least 2x the amount of RAM.<li>2 GB to 8 GB of RAM: Swap can be equal to the amount of RAM or up to 1.5x the RAM.<li>8 GB to 16 GB of RAM: Swap can be equal to the amount of RAM or slightly less (e.g., 0.5x to 1x the RAM).<li>More than 16 GB of RAM: Swap size is often equal to the RAM size or even smaller (e.g., 4 GB to 8 GB), depending on your needs.</ul><p>Now to enable the swap file:<pre class=z-code><code><span class="z-text z-plain"># swapon /swapfile
</span></code></pre><p>And too keep it across reboots we can add the following line to <code>/etc/fstab</code><pre class=z-code><code><span class="z-text z-plain">/etc/fstab
    /swapfile none swap defaults 0 0
</span></code></pre><p>Great! Now we have swap enabled on our system. You can check that by doing<pre class="language-bash z-code" data-lang=bash><code class=language-bash data-lang=bash><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">free</span></span>
</span></code></pre><p>And you should see something like this on your terminal<pre class=z-code><code><span class="z-text z-plain">               total        used        free      shared  buff/cache   available
Mem:         7034596     4476296      471520       67164     2432656     2558300
Swap:       12582908     2605912     9976996
</span></code></pre><h2 id=enabling-hibernation>Enabling hibernation</h2><p>To enable hibernation, we will need to add two kernel parameters to our configuration. The first one is <code>resume</code> to tell the kernel in which device the <code>swapfile</code> is and the second one is <code>resume_offset</code> to tell the kernel in which part of the device (aka offset) the <code>swapfile</code> is located.<h3 id=get-resume-parameter>Get <code>resume</code> parameter</h3><p>For the <code>resume</code> parameter, we will use the UUID of the disk that contains the <code>swapfile</code>. To find the UUID value first you'll need to know in which disk your <code>swapfile</code> is:<pre class="language-bash z-code" data-lang=bash><code class=language-bash data-lang=bash><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">df</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>h</span> /swapfile</span>
</span></code></pre><p>You should see an output like this:<pre class=z-code><code><span class="z-text z-plain">Filesystem           Size  Used Avail Use% Mounted on
/dev/mapper/vg-root  305G   80G  210G  28% /
</span></code></pre><p>Which indicates that the <code>/swapfile</code> is on device <code>/dev/mapper/vg-root</code>. Now to get the UUID of that device we can do:<pre class="language-bash z-code" data-lang=bash><code class=language-bash data-lang=bash><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">sudo</span></span><span class="z-meta z-function-call z-arguments z-shell"> blkid /dev/mapper/vg-root</span>
</span></code></pre><p>Wich should return something like this:<pre class=z-code><code><span class="z-text z-plain">/dev/mapper/vg-root: UUID="df9c76a1-25bc-4f83-8569-c9425a86115d" BLOCK_SIZE="4096" TYPE="ext4"
</span></code></pre><p>Great! So now we have our first kernel parameter value. Now let's get the second one.<h3 id=get-resume-offset-parameter>Get <code>resume_offset</code> parameter</h3><p>You can check the <a href=https://wiki.archlinux.org/title/Power_management/Suspend_and_hibernate#Acquire_swap_file_offset>Arch wiki article</a> for this as well.<p>To get the <code>resume_offset</code> value, we can run the following command:<pre class="language-bash z-code" data-lang=bash><code class=language-bash data-lang=bash><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">sudo</span></span><span class="z-meta z-function-call z-arguments z-shell"> filefrag<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>v</span> /swapfile</span>
</span></code></pre><p>Which should return something like this:<pre class=z-code><code><span class="z-text z-plain">Filesystem type is: ef53
File size of /swapfile is 4294967296 (1048576 blocks of 4096 bytes)
 ext:     logical_offset:        physical_offset: length:   expected: flags:
   0:        0..       0:      38912..     38912:      1:
   1:        1..   22527:      38913..     61439:  22527:             unwritten
   2:    22528..   53247:     899072..    929791:  30720:      61440: unwritten
...
</span></code></pre><p>We are interested in the first <code>physical_offset</code> value which in this case is <code>38912</code>. You can also get the direct value of the offset by using <code>awk</code><pre class=z-code><code><span class="z-text z-plain">sudo filefrag -v swap_file | awk '$1=="0:" {print substr($4, 1, length($4)-2)}'
</span></code></pre><h3 id=adding-the-parameter-to-the-kernel-cmd-line>Adding the parameter to the kernel cmd line</h3><p>Now that we have the <code>uuid</code> of the device where the <code>/swapfile</code> is and the <code>offset</code> of the <code>/swapfile</code> file in this device, we can add the values to the kernel parameters.<p>Remeber that the value we found previously where <code>"df9c76a1-25bc-4f83-8569-c9425a86115d"</code> for the UUID of the disk and <code>38912</code> for the offset of the <code>/swapfile</code>. Now well need to tell the kernel this so it can be able to find the <code>/swapfile</code> on boot.<p>To do this in <code>dracut</code> open the <code>/etc/dracut.conf.d/cmdline.conf</code> file, where you should see something like this:<pre class=z-code><code><span class="z-text z-plain">kernel_cmdline="rd.lunks.uuid=luks-42eb3f89-15a3-427c-9cab-8bcc8d19f94c rd.lvm.lv=vg/root root=/dev/mapper/vg-root rootfstype=ext4 rootflags=rw,relatime"
</span></code></pre><p>Now simply add the <code>resume</code> and <code>resume_offset</code> parameters. At the end of the line and <strong>remember to close with a quote character</strong>. Also for the <code>resume</code> parameter, you'll need to tell the kernel you are providing the UUID of the device, this is simply done by appending <code>=UUID</code> after <code>resume</code> (so your kernel parameter should look like <code>resume=UUID=&LTuuid of the device></code>):<p>Your <code>cmdline.conf</code> file should now look like this:<pre class=z-code><code><span class="z-text z-plain">kernel_cmdline="rd.lunks.uuid=luks-42eb3f89-15a3-427c-9cab-8bcc8d19f94c rd.lvm.lv=vg/root root=/dev/mapper/vg-root rootfstype=ext4 rootflags=rw,relatime resume=UUID=df9c76a1-25bc-4f83-8569-c9425a86115d resume_offset=38912"
</span></code></pre><h3 id=rebuilding-your-unified-kernel-image>Rebuilding your unified kernel image</h3><p>Not sure if this step is needed, but I do it anyway. To rebuild the unified kernel image I simply reinstall the <code>linux</code> kernel:<pre class="language-bash z-code" data-lang=bash><code class=language-bash data-lang=bash><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">sudo</span></span><span class="z-meta z-function-call z-arguments z-shell"> pacman<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>S</span> linux</span>
</span></code></pre><h2 id=some-tips>Some tips</h2><p>If you have enough ram and you just want swap in your system for hibernation, you can <a href=https://wiki.archlinux.org/title/Swap#Swappiness>configure the swappiness</a> on your devices such that it is never actually used.</section></article></main></div><footer><section><nav><a class="nav-links social" rel="noopener noreferrer" href=https://www.linkedin.com/in/aparkerdf/ target=_blank> <img alt=linkedin src=/social_icons/linkedin.svg title=linkedin> </a><a class="nav-links social" rel="noopener noreferrer" href=https://github.com/AlvaroParker target=_blank> <img alt=github src=/social_icons/github.svg title=github> </a><a class="nav-links social" rel="noopener noreferrer" href=https://gitlab.com/AlvaroParker target=_blank> <img alt=gitlab src=/social_icons/gitlab.svg title=gitlab> </a><a class="nav-links social" rel="noopener noreferrer" href=mailto:aparkerdf@protonmail.com target=_blank> <img alt=mail src=/social_icons/email.svg title=mail> </a></nav></section><script src=https://await.cl/js/main.js></script></footer>